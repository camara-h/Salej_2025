---
title: "Gavrila_reactome_summary"
author: "Henrique Camara"
date: '2024-06-13'
output: html_document
---

```{r setup, include=FALSE}
library(ggplot2)
library(tidyverse)
library(stringr)
library(ggpubr)

# Define a custom theme
custom_theme <- theme_bw() + theme(
  axis.title = element_text(size = 14),
  axis.text = element_text(size = 12),
  plot.title = element_text(size = 18, face = "bold"),
  legend.title = element_text(size = 14),
  legend.text = element_text(size = 12),
  strip.text = element_text(size = 14)
)

# Apply the theme globally
theme_set(custom_theme)

# Function to wrap text
wrap_text <- function(x, width) {
  sapply(str_wrap(x, width = width), paste, collapse = "\n")
}

#
# # Function to wrap text
# wrap_text <- function(x, width) {
#   str_wrap(x, width = width)
# }

format_text <- function(text) {
  # Convert text to uppercase
  text_upper <- str_to_upper(text)

  # Replace special characters with underscores
  text_clean <- str_replace_all(text_upper, "[^A-Z0-9]", "_")
  text_clean <- gsub("__", "_", text_clean) # Replace potential double underscores created

  return(text_clean)
}
```

## Introduction


2) Extract the pathway name, significance and direction for each correlation. This will tell us for each covariate, what are the consistent changes.
```{r}
path_list <- list(
  Covar_adjusted = read.csv("../data/BMI_temp_covars/gene_stats.csv", row.names = 1)
)

path_list[[1]]
path_list[[1]] <- path_list[[1]] %>% rownames_to_column("ensembl_id")
```

```{r}
pivot_and_clean <- function(data, pattern, value_name) {
  data %>%
    select(contains(pattern), ensembl_id) %>%
    pivot_longer(cols = contains(pattern), names_to = "var", values_to = value_name) %>%
    mutate(var = str_replace(var, "\\.[^\\.]*$", "")) # Search backward to last dot and remove extension
}

df <- path_list[[1]]
slope_df <- pivot_and_clean(df, "slope", "slope")
pval_df <- pivot_and_clean(df, ".p", "p_val")
fdr_df <- pivot_and_clean(df, "FDR", "FDR")
gene_info_df <- df %>% select(-contains("."))

final_df <- left_join(slope_df, pval_df, by = c("var", "ensembl_id")) %>%
  left_join(fdr_df, by = c("var", "ensembl_id")) %>%
  left_join(gene_info_df, by = "ensembl_id")

# Remove combined correlations and separate the vars
final_df <- final_df %>%
  filter(!str_detect(var, "^Deep_and_SC")) %>%
  separate(var, into = c("tissue", "var"), sep = "\\.")
```


```{r}
plot_data <- final_df %>%
  filter(symbol%in% c("UCP1", "PPARGC1A", "CKMT1")) %>%
  mutate(
    significance = FDR < 0.50,
    stroke_width = ifelse(significance, 1.5, 0.3),
    significance_label = ifelse(significance, "FDR < 0.05", "Not Significant"),
    rounded_slope = round(slope, 2)  # round to 2 decimal places
  )

p <- ggplot(plot_data, aes(x = var, y = symbol)) +
  geom_point(
    aes(fill = slope, stroke = stroke_width), 
    shape = 21, color = "black", size = 3.5
  ) +
  geom_text(
    aes(label = rounded_slope), 
    size = 3/2.81, 
    color = "black", 
    fontface = "bold"
  ) +
  scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +
  theme_pubr() +
  theme(
    base_size = 6, 
    base_family = "Arial", 
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)
  )

p

# Save plot
scale <- 90
ggsave(paste0("../output/4 - Figures and Analysis/figures/Figure_4.png"), create.dir = T, plot = p, device = "png", width = 1 * scale, height = 1 * scale, units = "mm", dpi = 600, bg = "white")
```
